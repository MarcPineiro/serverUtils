---

# Arquitectura completa (versiÃ³n final consolidada)

## Objetivo

Disponer de un **sistema de provisionamiento y gestiÃ³n completamente automÃ¡tico**, donde:

* Un **USB supervisor** garantiza que el portÃ¡til principal tenga siempre:

  * Ubuntu 24.04 LTS correcto
  * cloud-init apuntando a GitHub
  * configuraciÃ³n convergente
* Ese portÃ¡til se convierte en:

  * **Servidor PXE**
  * **Orquestador Ansible**
  * **Controlador CI/CD interno**
* El resto de mÃ¡quinas (**NAS, Proxmox, PortÃ¡til2**) se:

  * instalan automÃ¡ticamente si estÃ¡n vacÃ­as o mal
  * se identifican por MAC
  * se configuran y mantienen por Ansible (pull + push)

Todo el sistema es **idempotente**, **reparable** y **versionado**.

---

## FASE 1 â€” USB Supervisor (arranque inicial)

### QuÃ© hace el USB

El USB **arranca siempre primero** y ejecuta un script descargado desde GitHub.

Ese script:

1. Detecta el HDD interno
2. Comprueba:

   * Â¿Hay Linux instalado?
   * Â¿Es Ubuntu 24.04 LTS?
   * Â¿GRUB tiene el cmdline correcto con NoCloud `s=URL`?
   * Â¿Existe el flag de versiÃ³n de configuraciÃ³n?
3. ActÃºa segÃºn el estado:

| Estado detectado    | AcciÃ³n                               |
| ------------------- | ------------------------------------ |
| No hay SO           | Instala Ubuntu 24.04 automÃ¡ticamente |
| SO â‰  24.04          | Reinstala                            |
| 24.04 pero GRUB mal | Corrige GRUB                         |
| Todo correcto       | Arranca HDD                          |

4. Fuerza el arranque desde HDD

> El USB **nunca configura** el sistema: solo garantiza que el HDD arrancarÃ¡ en el estado esperado.

---

## FASE 2 â€” Ubuntu Supervisor (primer boot del HDD)

### Cloud-init (NoCloud seedfrom)

Ubuntu arranca con kernel cmdline similar a:

```
ds=nocloud;s=https://config.tudominio/supervisor/24.04/
```

En esa URL existen:

```
/user-data
/meta-data
/vendor-data        (opcional)
/network-config     (opcional)
```

Cloud-init solo hace **bootstrap mÃ­nimo**:

1. Red funcional
2. SSH keys
3. Instala:

   * python
   * git
   * ansible
4. Clona repo de infraestructura
5. Ejecuta:

   ```bash
   ansible-pull -U https://github.com/tuorg/infra-config.git supervisor.yml
   ```
6. Escribe:

   ```
   /var/lib/autoprov/config_version
   ```

âš ï¸ **Toda la lÃ³gica compleja va en Ansible**, no en cloud-init.

---

## FASE 3 â€” Supervisor como servidor PXE

El supervisor levanta:

* `dnsmasq` â†’ DHCP + TFTP
* `iPXE` â†’ primer cargador
* `HTTP (nginx/caddy)` â†’ kernels, initrds, configs

### Flujo PXE real

1. MÃ¡quina cliente arranca por red
2. DHCP entrega `ipxe.efi`
3. iPXE descarga `boot.ipxe` por HTTP
4. Se muestra **menÃº PXE con timeout**

---

## MenÃº PXE con timeout (cambio clave)

El menÃº permite:

* **Modo automÃ¡tico (default)** â†’ por MAC
* **Modo manual** â†’ si se pulsa una tecla

### LÃ³gica del menÃº

1. iPXE detecta MAC
2. Busca el rol asociado
3. Muestra menÃº durante X segundos
4. Si no hay interacciÃ³n:

   * arranca la instalaciÃ³n automÃ¡tica correcta
5. Si hay interacciÃ³n:

   * permite elegir manualmente

### Seguridad incluida

Si una MAC **no estÃ¡ registrada**:

* el default es:

  * *Boot from local disk*
  * o *Mostrar menÃº sin autoinstall*

Esto evita instalaciones accidentales.

---

## IdentificaciÃ³n de mÃ¡quinas (rol)

La identificaciÃ³n se hace **principalmente por MAC**.

Ejemplo de roles:

| MÃ¡quina   | Rol       | SO           |
| --------- | --------- | ------------ |
| NAS       | `nas`     | Debian + OMV |
| Server    | `proxmox` | Proxmox VE   |
| PortÃ¡til2 | `edge`    | Ubuntu 24.04 |

El rol decide:

* quÃ© instalador arrancar
* quÃ© configuraciÃ³n aplicar
* quÃ© playbook ejecutar

---

## FASE 4 â€” InstalaciÃ³n automÃ¡tica por tipo de mÃ¡quina

### 1ï¸âƒ£ NAS â€” Debian + OMV

* Arranque PXE â†’ Debian netinst
* Kernel params incluyen:

  ```
  auto=true priority=critical preseed/url=http://supervisor/preseed/nas.cfg
  ```
* Preseed:

  * particionado
  * usuario + SSH
  * sistema mÃ­nimo
* Post-install:

  * OMV se instala encima
* Ansible:

  * discos
  * shares
  * NFS / iSCSI

---

### 2ï¸âƒ£ Proxmox Server

* Arranque PXE â†’ instalador Proxmox automatizado
* Answer file servido por HTTP
* InstalaciÃ³n desatendida
* Post-install:

  * Ansible:

    * red
    * usuarios
    * storage remoto (NAS)
* Terraform (opcional):

  * VMs
  * CTs
  * redes
  * cloud-init de VMs

> Terraform **solo gestiona Proxmox**, nunca baremetal.

---

### 3ï¸âƒ£ PortÃ¡til2 â€” Edge node

* Arranque PXE â†’ Ubuntu autoinstall
* Cloud-init NoCloud `s=.../portatil2/24.04/`
* Ansible:

  * VPN
  * DNS
  * GitHub runners
  * servicios edge

Este nodo tiene acceso L3 a toda la red interna.

---

## FASE 5 â€” GestiÃ³n continua (Ansible pull + push)

### Pull (estado real)

Todos los hosts tienen:

* `ansible-pull` por systemd timer
* convergencia garantizada
* repositorio comÃºn

Ejemplo:

```
*/15 * * * * ansible-pull
```

---

### Push (acelerador desde CI)

Los **GitHub Workflows**, ejecutados en el runner del PortÃ¡til2:

1. PR â†’ entorno de pruebas (VMs/CTs)
2. Merge â†’ producciÃ³n
3. Si el PR marca `critical-change=true`:

   * despliegue inmediato

Dos opciones vÃ¡lidas:

* Push directo (`ansible-playbook`)
* SeÃ±al de ejecuciÃ³n inmediata del pull (recomendado)

ðŸ“Œ **Modelo recomendado**:

* Pull = verdad
* Push = acelerar, no sustituir

---

## Diagrama de estados final

```mermaid
stateDiagram-v2
  [*] --> USB_Boot

  state "USB Supervisor" as USB_Boot {
    [*] --> Inspect_HDD
    Inspect_HDD --> Install_Ubuntu: no SO / wrong SO
    Inspect_HDD --> Fix_GRUB: SO ok, cmdline wrong
    Inspect_HDD --> Boot_HDD: everything ok
    Install_Ubuntu --> Boot_HDD
    Fix_GRUB --> Boot_HDD
  }

  Boot_HDD --> Ubuntu_Supervisor

  state "Ubuntu Supervisor" as Ubuntu_Supervisor {
    [*] --> CloudInit
    CloudInit --> Ansible_Supervisor
    Ansible_Supervisor --> PXE_Online
  }

  PXE_Online --> PXE_Menu

  state "PXE Clients" as PXE_Menu {
    [*] --> Menu
    Menu --> Auto_Select: timeout
    Menu --> Manual_Select: keypress

    Auto_Select --> NAS_Install: MAC=NAS
    Auto_Select --> Proxmox_Install: MAC=Server
    Auto_Select --> Edge_Install: MAC=Portatil2

    Manual_Select --> NAS_Install
    Manual_Select --> Proxmox_Install
    Manual_Select --> Edge_Install

    NAS_Install --> NAS_Ansible
    Proxmox_Install --> Proxmox_Ansible
    Edge_Install --> Edge_Ansible
  }
```

---
