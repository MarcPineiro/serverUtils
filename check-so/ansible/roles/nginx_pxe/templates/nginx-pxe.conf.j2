# nginx configuration for PXE server
# roles/nginx_pxe/templates/nginx-pxe.conf.j2

server {
    listen 80 default_server;
    listen [::]:80 default_server;

    server_name _;
    root {{ http_root }};

    # Logging
    access_log /var/log/nginx/pxe-access.log;
    error_log /var/log/nginx/pxe-error.log;

    # Main index
    location = / {
        index index.html index.htm;
    }

    # Boot images (kernels, initrds)
    location /boot/ {
        autoindex on;
        autoindex_exact_size off;
        autoindex_localtime on;
    }

    # Preseed configurations (for Debian/Ubuntu netinstall)
    location /preseed/ {
        autoindex on;
        # Serve preseed files with correct MIME type
        types {
            text/plain cfg;
        }
    }

    # Cloud-init seeds (NoCloud datasource)
    location /cloud-init/ {
        autoindex on;
        # Cloud-init expects user-data and meta-data without extension
        types {
            text/plain "";
        }
        default_type text/plain;
    }

    # TFTP mirror (for iPXE chainloading)
    location /tftp/ {
        autoindex on;
    }

    # Deny access to system files
    location ~ /\. {
        deny all;
        access_log off;
        log_not_found off;
    }

    # Caching headers
    location ~* \.(jpg|jpeg|png|gif|ico|css|js|svg|woff|woff2)$ {
        expires 30d;
        add_header Cache-Control "public, immutable";
    }

    # No caching for dynamic content
    location ~ ^/(preseed|cloud-init)/ {
        expires -1;
        add_header Cache-Control "no-cache, no-store, must-revalidate";
    }
}
