---
# roles/nginx_pxe/tasks/main.yml
# Configura nginx como servidor HTTP para PXE, preseed, cloud-init y kernels

- name: Ensure nginx is installed
  apt:
    name: nginx
    state: present

- name: Create nginx directories
  file:
    path: "{{ item }}"
    state: directory
    mode: '0755'
    owner: www-data
    group: www-data
  loop:
    - "{{ http_root }}"
    - "{{ tftp_root }}"
    - "{{ boot_dir }}"
    - "{{ preseed_dir }}"
    - "{{ cloud_init_dir }}"

- name: Configure nginx for PXE
  template:
    src: nginx-pxe.conf.j2
    dest: /etc/nginx/sites-available/pxe
    mode: '0644'
  notify: restart nginx

- name: Enable nginx PXE site
  file:
    src: /etc/nginx/sites-available/pxe
    dest: /etc/nginx/sites-enabled/pxe
    state: link
  notify: restart nginx

- name: Disable default nginx site
  file:
    path: /etc/nginx/sites-enabled/default
    state: absent
  notify: restart nginx

- name: Create index.html
  copy:
    content: |
      <!DOCTYPE html>
      <html>
      <head>
        <title>PXE Server</title>
      </head>
      <body>
        <h1>PXE Server Online</h1>
        <p>Supervisor: {{ ansible_hostname }}</p>
        <ul>
          <li><a href="/boot/">Boot Images</a></li>
          <li><a href="/preseed/">Preseed Configs</a></li>
          <li><a href="/cloud-init/">Cloud-Init Seeds</a></li>
          <li><a href="/tftp/">TFTP Files</a></li>
        </ul>
      </body>
      </html>
    dest: "{{ http_root }}/index.html"
    mode: '0644'
    owner: www-data
    group: www-data

- name: Enable nginx on boot
  systemd:
    name: nginx
    enabled: yes
    state: started

- name: Test nginx configuration
  shell: nginx -t
  changed_when: false
  register: nginx_test
  failed_when: nginx_test.rc != 0

# Healthchecks
- name: "[HEALTHCHECK] Wait for nginx to be ready"
  wait_for:
    port: 80
    delay: 2
    timeout: 30
  ignore_errors: yes
  register: nginx_port_check

- name: "[HEALTHCHECK] Verify nginx is running"
  systemd:
    name: nginx
  register: nginx_running
  failed_when: nginx_running.status.ActiveState != 'active'
  ignore_errors: yes

- name: "[HEALTHCHECK] Test HTTP response from index"
  uri:
    url: "http://localhost/index.html"
    status_code: 200
  register: http_index_check
  retries: 3
  delay: 2
  until: http_index_check.status | default(0) == 200
  ignore_errors: yes

- name: "[HEALTHCHECK] Test cloud-init seed accessibility"
  uri:
    url: "http://localhost/cloud-init/user-data"
    method: HEAD
  register: seed_accessibility
  ignore_errors: yes

- name: "[HEALTHCHECK] Verify directory permissions"
  stat:
    path: "{{ item }}"
  register: dir_stats
  loop:
    - "{{ boot_dir }}"
    - "{{ preseed_dir }}"
    - "{{ cloud_init_dir }}"

- name: "[HEALTHCHECK] Display nginx status"
  debug:
    msg:
      - "nginx HTTP Server Status:"
      - "  Port 80: {{ 'OK ✓' if nginx_port_check is not skipped and nginx_port_check.rc == 0 else 'FAILED ✗' }}"
      - "  Service status: {{ nginx_running.status.ActiveState | default('unknown') }}"
      - "  Config test: {{ 'OK ✓' if nginx_test.rc == 0 else 'FAILED ✗' }}"
      - "  HTTP index: {{ 'OK ✓' if http_index_check.status | default(0) == 200 else 'FAILED ✗' }}"
      - "  HTTP root: {{ http_root }}"
