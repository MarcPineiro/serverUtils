#!ipxe
# roles/ipxe_bootloader/templates/menu.ipxe.j2
# Main PXE menu with machine detection and manual options

# MAC address of this machine
set machine_mac ${net0/mac}

# Known machines (modify as needed)
# MAC -> Role mapping
isset ${machine_nas_mac} || set machine_nas_mac 08:00:27:00:00:01
isset ${machine_proxmox_mac} || set machine_proxmox_mac 08:00:27:00:00:02
isset ${machine_edge_mac} || set machine_edge_mac 08:00:27:00:00:03

echo
echo ========================================
echo     PXE Boot Menu
echo ========================================
echo MAC Address: ${machine_mac}
echo Host IP: ${net0/ip}
echo Host GW: ${net0/gw}
echo ========================================
echo

# Auto-select based on MAC (no timeout if detected)
iseq ${machine_mac} ${machine_nas_mac} && goto nas_boot
iseq ${machine_mac} ${machine_proxmox_mac} && goto proxmox_boot
iseq ${machine_mac} ${machine_edge_mac} && goto edge_boot

# If not recognized, show menu with timeout
:menu
echo
echo [1] NAS (Debian + OMV)
echo [2] Proxmox Server
echo [3] Edge Node (Ubuntu)
echo [4] Boot from local disk
echo [5] Reboot
echo
echo Auto-selecting 'Boot from local disk' in 30 seconds...
echo Press a key for manual selection...

# Timeout: 30 seconds = 30000 ms
set menu-timeout 30000
set chosen 0

# Menu selection logic
choose --timeout ${menu-timeout} chosen 1 2 3 4 5 || goto boot_local

iseq ${chosen} 1 && goto nas_boot
iseq ${chosen} 2 && goto proxmox_boot
iseq ${chosen} 3 && goto edge_boot
iseq ${chosen} 4 && goto boot_local
iseq ${chosen} 5 && reboot

# Unknown selection, try again
goto menu

# ========================================
# Boot options per machine type
# ========================================

:nas_boot
echo Booting NAS configuration...
chain http://{{ ansible_default_ipv4.address | default('192.168.1.1') }}/boot/machines/nas.ipxe
exit

:proxmox_boot
echo Booting Proxmox Server configuration...
chain http://{{ ansible_default_ipv4.address | default('192.168.1.1') }}/boot/machines/proxmox.ipxe
exit

:edge_boot
echo Booting Edge Node configuration...
chain http://{{ ansible_default_ipv4.address | default('192.168.1.1') }}/boot/machines/edge.ipxe
exit

:boot_local
echo Booting from local disk...
sanboot --no-describe --drive 0x80

:reboot
echo Rebooting...
reboot
