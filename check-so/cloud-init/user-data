#cloud-config
# Ubuntu 24.04 Supervisor - Fase 2: Bootstrap mínimo + Ansible pull
# Este fichero se sirve via cloud-init NoCloud desde GitHub

autoinstall:
  version: 1
  identity:
    hostname: supervisor
    username: autoprov
    # Contraseña: autoprov (hash generado con: openssl passwd -6 'autoprov')
    password: "$6$rounds=4096$abcdefghijklmno$7JhYfLw0F7CXn5h8K9q2/W1n3m4p5q6r7s8t9u0v1w2x3y4z5a6b7c8d9e0f"
  ssh:
    install-server: true
    # Permitir login con contraseña (en producción usar SSH keys)
    allow-pw: true
  locale: en_US.UTF-8
  keyboard:
    layout: us
  network:
    network-config:
      version: 2
      ethernets:
        eth0:
          dhcp4: true
  storage:
    layout:
      name: direct
  updates: all
  # Paquetes mínimos para PXE server
  packages:
    - openssh-server
    - python3
    - python3-pip
    - git
    - curl
    - wget
    - ansible
    - dnsmasq
    - nginx
    - ipxe
    - grub-pc-bin
    - xorriso
    - curl
    - systemd-resolved
    - sudo

# Pasos post-instalación
late-commands:
  # 1. Crear directorio de configuración Ansible
  - mkdir -p /home/autoprov/.ansible
  # 2. Crear estructura de directorios PXE
  - mkdir -p /srv/http/tftp /srv/http/boot /srv/http/preseed /srv/http/cloud-init
  # 3. Configurar permisos
  - chown -R autoprov:autoprov /home/autoprov
  - |
    cat >> /etc/sudoers.d/autoprov <<EOF
    autoprov ALL=(ALL) NOPASSWD:ALL
    EOF
  - chmod 0440 /etc/sudoers.d/autoprov

# Boot commands - Se ejecutan al final
bootcmd:
  # Esperar a que la red esté lista
  - while ! ip addr show | grep -q "inet "; do sleep 1; done
  # Crear directorio de marca de convergencia
  - mkdir -p /var/lib/autoprov
  - touch /var/lib/autoprov/bootstrap_started

# Final steps - Se ejecutan como root al final de cloud-init
runcmd:
  # 1. Esperar disponibilidad de red
  - sleep 5
  # 2. Clonar repositorio de configuración
  - sudo -u autoprov git clone https://github.com/MarcPineiro/serverUtils.git /home/autoprov/serverUtils
  # 3. Ejecutar ansible-pull para converger configuración
  - |
    sudo -u autoprov /usr/bin/ansible-pull \
      -U https://github.com/MarcPineiro/serverUtils.git \
      -d /home/autoprov/serverUtils \
      -C main \
      -i "localhost," \
      personal/serverUtils/check-so/ansible/supervisor.yml \
      -e "ansible_connection=local supervisor_role=pxe_server"
  # 4. Crear marca de convergencia exitosa
  - mkdir -p /var/lib/autoprov
  - echo "1" > /var/lib/autoprov/config_version
  # 5. Iniciar servicios PXE
  - systemctl enable dnsmasq nginx
  - systemctl restart dnsmasq nginx
  # 6. Configurar systemd-resolved para DNS local
  - |
    mkdir -p /etc/systemd/resolved.conf.d
    cat > /etc/systemd/resolved.conf.d/pxe.conf <<EOF
    [Resolve]
    DNSSec=no
    DNS=127.0.0.1
    FallbackDNS=8.8.8.8 8.8.4.4
    EOF
  - systemctl restart systemd-resolved

# Configuración de usuarios
users:
  - name: autoprov
    gecos: Autoprov User
    groups: sudo,adm
    sudo: ALL=(ALL) NOPASSWD:ALL
    shell: /bin/bash
    lock-passwd: false

# SSH config
ssh_deletekeys: false
ssh_genkeytypes: ['rsa', 'ecdsa', 'ed25519']

# Evitar poweroff/reboot automático
power_state:
  delay: 0
  mode: none
  timeout: 0
